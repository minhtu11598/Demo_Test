trigger: none
name: Chrome_Checker_$(Date:yyyyMMdd)$(Rev:.r)

stages:
- stage: ChromeCheck
  displayName: "Chrome Checker"
  jobs:
  - job: CheckChrome
    displayName: "Check Chrome Version"
    steps:

    # -------------------------------------------
    # 1) Get latest Chrome version from API
    # -------------------------------------------
    - task: PowerShell@2
      name: GetLatestChromeVersionAPI
      displayName: "Get latest Chrome version"
      inputs:
        targetType: inline
        script: |
          $api = "https://versionhistory.googleapis.com/v1/chrome/platforms/win/channels/stable/versions"
          Write-Host "Calling Chrome API..."
          $response = Invoke-RestMethod -Uri $api -Method GET

          $latestVersion = $response.versions[0].version

          Write-Host "Latest Chrome version is: $latestVersion"
          echo "##vso[task.setvariable variable=latestVersion;isOutput=true]$latestVersion"

    # -------------------------------------------
    # 2) Compare stored version vs latest version
    # -------------------------------------------
    - task: PowerShell@2
      name: CompareVersion
      displayName: "Compare Chrome versions"
      inputs:
        targetType: inline
        script: |
          $currentVersion = "$(current.chrome.version)"
          $latestVersion = "$(GetLatestChromeVersionAPI.latestVersion)"

          Write-Host "Current stored version : $currentVersion"
          Write-Host "Latest available version: $latestVersion"

          if ($currentVersion -ne $latestVersion) {
            Write-Host "âœ¨ NEW Chrome version detected!"
            echo "##vso[task.setvariable variable=newChromeAvailable;isOutput=true]true"
          }
          else {
            Write-Host "No new Chrome version."
            echo "##vso[task.setvariable variable=newChromeAvailable;isOutput=true]false"
          }

    # -------------------------------------------
    # 3) Update the variable so next run uses new version
    # -------------------------------------------
    - task: PowerShell@2
      name: UpdateVariable
      displayName: "Update current.chrome.version for next run"
      condition: eq(variables['CompareVersion.newChromeAvailable'], 'true')
      inputs:
        targetType: inline
        script: |
          $newVersion = "$(GetLatestChromeVersionAPI.latestVersion)"
          Write-Host "Updating pipeline variable current.chrome.version to: $newVersion"

          # This updates the pipeline variable permanently
          echo "##vso[task.setvariable variable=current.chrome.version;isOutput=false;issecret=false]$newVersion"
