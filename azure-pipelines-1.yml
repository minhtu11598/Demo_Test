# ============================
#   Chrome_Checker Pipeline
# ============================

trigger:
- Chrome_checker

pool:
  name: SelfHostedPool

variables:
  # URL for Chrome latest version API
  chrome.latest.version.url: "https://versionhistory.googleapis.com/v1/chrome/platforms/win/channels/stable/versions"

  # Store your current Chrome version here
  # (You can update manually OR save it in Library variable group)
  current.chrome.version: "0.0.0.0"

stages:
- stage: CheckChromeVersion
  displayName: "Check for new Chrome version"

  jobs:
  - job: VersionCheck
    displayName: "Check Chrome version"

    steps:

    # ---------------------------------------
    # Step 1 ‚Äî Get latest version from API
    # ---------------------------------------
    - task: PowerShell@2
      name: GetLatestChromeVersionAPI
      displayName: "Get Chrome Version from Google API"
      inputs:
        targetType: 'inline'
        script: |
          Write-Host "üîç Checking latest Chrome version from Google API..."

          $response = Invoke-RestMethod -Uri "$(chrome.latest.version.url)"
          $latestVersion = $response.versions[0].version

          Write-Host "Latest Chrome Version: $latestVersion"

          # Set output + pipeline variable
          echo "##vso[task.setvariable variable=latestVersion;isOutput=true]$latestVersion"
          echo "##vso[task.setvariable variable=latestVersion]$latestVersion"


    # ---------------------------------------
    # Step 2 ‚Äî Compare latest vs current
    # ---------------------------------------
    - task: PowerShell@2
      name: CompareVersions
      displayName: "Compare with current stored version"
      inputs:
        targetType: "inline"
        script: |
          $currentVersion = "$(current.chrome.version)"
          $latestVersion = "$(GetLatestChromeVersionAPI.latestVersion)"

          Write-Host "Current stored version: $currentVersion"
          Write-Host "Latest available version: $latestVersion"

          if ($currentVersion -ne $latestVersion) {
            Write-Host "‚ú® NEW Chrome version detected!"
            echo "##vso[task.setvariable variable=newChromeAvailable;isOutput=true]true"
          } else {
            Write-Host "No new Chrome version."
            echo "##vso[task.setvariable variable=newChromeAvailable;isOutput=true]false"
          }


    # ---------------------------------------
    # Step 3 ‚Äî Save updateFlag.txt for Release Pipeline
    # ---------------------------------------
    - task: PowerShell@2
      name: WriteFlag
      displayName: "Write updateFlag.txt"
      inputs:
        targetType: 'inline'
        script: |
          $flag = "$(CompareVersions.newChromeAvailable)"

          Write-Host "Creating updateFlag.txt with value: $flag"

          $outDir = "$(Build.ArtifactStagingDirectory)"
          if (!(Test-Path $outDir)) { New-Item -ItemType Directory -Path $outDir | Out-Null }

          Set-Content -Path "$outDir/updateFlag.txt" -Value $flag


    # ---------------------------------------
    # Step 4 ‚Äî Optional: Save latest version to file
    # ---------------------------------------
    - task: PowerShell@2
      name: SaveLatestVersion
      displayName: "Save latest version to file"
      inputs:
        targetType: 'inline'
        script: |
          $version = "$(GetLatestChromeVersionAPI.latestVersion)"
          $outDir = "$(Build.ArtifactStagingDirectory)"

          Set-Content -Path "$outDir/latestVersion.txt" -Value $version
          Write-Host "Saved latestVersion.txt"


    # ---------------------------------------
    # Step 5 ‚Äî Publish artifact for Release Pipeline
    # ---------------------------------------
    - publish: $(Build.ArtifactStagingDirectory)
      artifact: chromeCheckerOutput
      displayName: "Publish Chrome Checker output artifact"
